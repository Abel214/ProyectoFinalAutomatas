<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cambio: usar url_for para los CSS - SIN duplicar static/ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/montyhall.css') }}">
    
    <title>Juego Monty Hall</title>
    <style>
        .monty-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .doors {
            display: flex;
            gap: 40px;
            margin: 30px 0;
        }
        .door {
            cursor: pointer;
            transition: transform 0.2s;
            height: 266px;
            width: 133px;
            object-fit: contain;
        }
        /* Botones de cambio centrados y separados */
        .change-btns {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 18px;
        }
        .door.selected {
            transform: scale(1.1);
            border: 2px solid #007bff;
        }
        .door-label {
            text-align: center;
            font-weight: bold;
            margin-top: 8px;
        }
        .presenter-img {
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .stats {
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-monty {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1em;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Estilos del laberinto */
        #maze {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            grid-template-rows: repeat(10, 40px);
            gap: 2px;
            margin-top: 20px;
        }
        .cell {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .wall {
            background: #222;
        }
        .start {
            background: #4caf50;
        }
        .end {
            background: #2196f3;
        }
        .particle {
            background: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <header>
        <a href="#" class="logo">AUTOMATAS</a>
        
        <nav>
            <!-- Cambio: usar url_for para las rutas de navegaci√≥n -->
            <a href="{{ url_for('index') }}" class="active"> Inicio</a>
            <a href="{{ url_for('laberinto') }}" >Juego</a>
            <a href="#" >Documentaci√≥n</a>
            <a href="#" >Acerca De</a>
        </nav>
    </header>

    <!-- Contenedor del laberinto reemplazando el monty-container -->
    <div class="monty-container">
        <h2>Laberinto: Mueve la part√≠cula roja con las flechas</h2>
        <div id="maze"></div>
        <p id="status"></p>
        <button id="new-game" class="btn-monty">Nueva partida</button>
        <button 
            id="view-glc-tree" 
            class="btn-monty" 
            style="background: #667eea; margin-left: 10px;"
            onclick="window.open('/glc/arbol', '_blank')"
        >
            üå≥ Ver √Årbol GLC
        </button>
    </div>

    <!-- Modal para Monty Hall -->
    <div id="monty-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    ">
        <div style="
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            min-width: 300px;
            text-align: center;
            position: relative;
        ">
            <h3>¬°Juego Monty Hall!</h3>
            <p>Elige una puerta:</p>
            <div id="monty-doors" style="
                display: flex;
                justify-content: center;
                gap: 30px;
                margin: 20px 0;
            "></div>
            <div id="monty-message"></div>
            <button id="monty-close" style="display: none; margin-top: 20px">Cerrar</button>
        </div>
    </div>

    <!-- L√≥gica del Monty Hall separada -->
    <script src="{{ url_for('static', filename='js/montyLaberinto.js') }}"></script>

    <script>
        // Generador simple de laberintos aleatorios con un camino garantizado
        function generateMaze(rows, cols) {
            // Inicializa todo como pared
            let maze = Array.from({ length: rows }, () => Array(cols).fill(1));
            // Crea un camino aleatorio desde (0,0) a (rows-1,cols-2)
            let x = 0, y = 0;
            maze[y][x] = 2; // inicio
            let path = [[x, y]];
            while (x < cols - 2 || y < rows - 1) {
                if (x === cols - 2) {
                    y++;
                } else if (y === rows - 1) {
                    x++;
                } else {
                    if (Math.random() < 0.5) x++;
                    else y++;
                }
                maze[y][x] = 0;
                path.push([x, y]);
            }
            maze[rows - 1][cols - 2] = 0;
            maze[rows - 1][cols - 1] = 3; // meta

            // A√±ade caminos secundarios aleatorios
            for (let i = 0; i < rows * cols * 0.25; i++) {
                let rx = Math.floor(Math.random() * cols);
                let ry = Math.floor(Math.random() * rows);
                if (maze[ry][rx] === 1) maze[ry][rx] = 0;
            }
            return maze;
        }

        let layout = generateMaze(10, 10);
        const maze = document.getElementById("maze");
        const rows = layout.length;
        const cols = layout[0].length;
        let particle = { x: 0, y: 0 };

        function renderMaze() {
            maze.innerHTML = "";
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = document.createElement("div");
                    cell.classList.add("cell");
                    if (layout[y][x] === 1) cell.classList.add("wall");
                    if (layout[y][x] === 2) cell.classList.add("start");
                    if (layout[y][x] === 3) cell.classList.add("end");
                    if (particle.x === x && particle.y === y)
                        cell.classList.add("particle");
                    maze.appendChild(cell);
                }
            }
        }

        function findStart() {
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    if (layout[y][x] === 2) {
                        particle.x = x;
                        particle.y = y;
                        return;
                    }
                }
            }
        }

        // Funci√≥n para mover la part√≠cula (usada por voz y teclado)
        function moveParticle(dx, dy) {
            const nx = particle.x + dx;
            const ny = particle.y + dy;
            if (
                nx >= 0 &&
                nx < cols &&
                ny >= 0 &&
                ny < rows &&
                layout[ny][nx] !== 1
            ) {
                particle.x = nx;
                particle.y = ny;
                renderMaze();
                if (layout[ny][nx] === 3) {
                    document.getElementById("status").textContent =
                        "¬°Llegaste al punto B!";
                } else {
                    document.getElementById("status").textContent = "";
                    // 10% de probabilidad de lanzar Monty Hall (y no en la meta ni en el inicio)
                    if (Math.random() < 0.1 && layout[ny][nx] === 0) {
                        showMontyHall(function (ganaste) {
                            if (!ganaste) {
                                findStart();
                                renderMaze();
                                document.getElementById("status").textContent =
                                    "¬°Perdiste en Monty Hall! Vuelves al inicio.";
                            } else {
                                document.getElementById("status").textContent =
                                    "¬°Ganaste en Monty Hall! Contin√∫as tu camino.";
                            }
                        });
                    }
                }
            }
        }

        // Eventos de teclado
        document.addEventListener("keydown", (e) => {
            if (e.key === "ArrowUp") moveParticle(0, -1);
            if (e.key === "ArrowDown") moveParticle(0, 1);
            if (e.key === "ArrowLeft") moveParticle(-1, 0);
            if (e.key === "ArrowRight") moveParticle(1, 0);
        });

        // Bot√≥n nueva partida
        document.getElementById("new-game").addEventListener("click", () => {
            layout = generateMaze(10, 10);
            findStart();
            renderMaze();
            document.getElementById("status").textContent = "";
        });

        // Reconocimiento de voz
        window.SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            const recognition = new window.SpeechRecognition();
            recognition.lang = "es-ES";
            recognition.continuous = true;
            recognition.interimResults = false;

            // Variables para Monty Hall por voz
            window.montyVoice = window.montyVoice || {
                active: false,
                selectDoor: null,
                selectAction: null,
            };

            recognition.onresult = function (event) {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript
                            .trim()
                            .toLowerCase();

                        // Enviar comando al sistema GLC para an√°lisis y registro
                        if (typeof enviarComandoGLC === 'function') {
                            enviarComandoGLC(transcript);
                        }

                        // Si el modal Monty Hall est√° activo
                        if (
                            document.getElementById("monty-modal").style.display === "flex"
                        ) {
                            if (transcript.includes("puerta a"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(0);
                            if (transcript.includes("puerta b"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(1);
                            if (transcript.includes("puerta c"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(2);
                            if (transcript.includes("cambiar"))
                                window.montyVoice.selectAction &&
                                    window.montyVoice.selectAction(true);
                            if (transcript.includes("mantener"))
                                window.montyVoice.selectAction &&
                                    window.montyVoice.selectAction(false);
                            if (transcript.includes("cerrar"))
                                window.montyVoice.closeModal &&
                                    window.montyVoice.closeModal();
                            if (transcript.includes("reiniciar") || transcript.includes("otra vez"))
                                window.montyVoice.restartGame &&
                                    window.montyVoice.restartGame();
                        } else {
                            // Comandos de movimiento normales
                            if (transcript.includes("izquierda")) moveParticle(-1, 0);
                            if (transcript.includes("derecha")) moveParticle(1, 0);
                            if (transcript.includes("arriba")) moveParticle(0, -1);
                            if (transcript.includes("abajo")) moveParticle(0, 1);
                        }
                    }
                }
            };

            recognition.onerror = function (e) {
                document.getElementById("status").textContent =
                    "Error de reconocimiento de voz: " + e.error;
            };

            recognition.start();
            document.getElementById("status").textContent =
                'Reconocimiento de voz activo. Di: "izquierda", "derecha", "arriba", "abajo", "puerta a/b/c", "cambiar", "mantener", "cerrar", "reiniciar".';
        } else {
            document.getElementById("status").textContent =
                "Reconocimiento de voz no soportado en este navegador.";
        }

        // Inicializar el juego
        findStart();
        renderMaze();
    </script>
    <!-- Integraci√≥n con sistema GLC -->
    <script src="{{ url_for('static', filename='js/integracionGLCVoz.js') }}"></script>
</body>
</html>
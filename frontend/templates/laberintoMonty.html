<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cambio: usar url_for para los CSS - SIN duplicar static/ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/montyhall.css') }}">
    
    <title>Juego Monty Hall</title>
 
</head>
<body>
    <header>
        <a href="#" class="logo">AUTOMATAS</a>
        
       <nav>
        <!-- Cambio importante: usar url_for para las rutas -->
        <a href="{{ url_for('index') }}" class="active"> Inicio</a>
        <a href="{{ url_for('laberinto') }}">Juego</a>
        <a href="{{ url_for('mostrar_arbol_voz') }}">GLC</a>
        <a href="{{ url_for('mostrar_automata_dinamico') }}" title="Autómata construido dinámicamente">Autómata</a>
    </nav>
    </header>

    <!-- Contenedor del laberinto reemplazando el monty-container -->
    <div class="monty-container">
        <h2>Laberinto: Mueve la partícula roja con la voz</h2>
        
        <div id="maze"></div>
        <p id="status"></p>
        <h2>Reconocimiento de voz activo. Di: "izquierda", "derecha", "arriba", "abajo", "puerta a/b/c", "cambiar", "mantener", "cerrar", "reiniciar"</h2>
        <div class="controls">
            <button id="new-game" class="btn">Nueva partida</button>
            <button id="go-to-automata" class="btn">
                Ir al Autómata
            </button>
        </div>
        
    </div>

    <!-- Modal de advertencia -->
    <div id="warning-modal" class="warning-modal">
        <div class="warning-content">
            <div class="warning-icon">⚠️</div>
            <div class="warning-title">¡Advertencia!</div>
            <div class="warning-message">
                Al ir al Autómata se reiniciará todo el progreso actual del juego, incluyendo tu posición en el laberinto y el historial de comandos.
                <br><br>
                ¿Deseas continuar con esta acción?
            </div>
            <div class="warning-buttons">
                <button id="confirm-continue" class="btn-warning btn-continue">
                    Sí, continuar
                </button>
                <button id="cancel-action" class="btn-warning btn-cancel">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Monty Hall -->
    <div id="monty-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    ">
        <div style="
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            min-width: 300px;
            text-align: center;
            position: relative;
        ">
            <h3>¡Juego Monty Hall!</h3>
            <p>Elige una puerta:</p>
            <div id="monty-doors" style="
                display: flex;
                justify-content: center;
                gap: 30px;
                margin: 20px 0;
            "></div>
            <div id="monty-message"></div>
            <button id="monty-close" style="display: none; margin-top: 20px">Cerrar</button>
        </div>
    </div>

    <!-- Lógica del Monty Hall separada -->
    <script src="{{ url_for('static', filename='js/montyLaberinto.js') }}"></script>

    <script>
        // Generador simple de laberintos aleatorios con un camino garantizado
        function generateMaze(rows, cols) {
            // Inicializa todo como pared
            let maze = Array.from({ length: rows }, () => Array(cols).fill(1));
            // Crea un camino aleatorio desde (0,0) a (rows-1,cols-2)
            let x = 0, y = 0;
            maze[y][x] = 2; // inicio
            let path = [[x, y]];
            while (x < cols - 2 || y < rows - 1) {
                if (x === cols - 2) {
                    y++;
                } else if (y === rows - 1) {
                    x++;
                } else {
                    if (Math.random() < 0.5) x++;
                    else y++;
                }
                maze[y][x] = 0;
                path.push([x, y]);
            }
            maze[rows - 1][cols - 2] = 0;
            maze[rows - 1][cols - 1] = 3; // meta

            // Añade caminos secundarios aleatorios
            for (let i = 0; i < rows * cols * 0.25; i++) {
                let rx = Math.floor(Math.random() * cols);
                let ry = Math.floor(Math.random() * rows);
                if (maze[ry][rx] === 1) maze[ry][rx] = 0;
            }
            return maze;
        }

        let layout = generateMaze(10, 10);
        const maze = document.getElementById("maze");
        const rows = layout.length;
        const cols = layout[0].length;
        let particle = { x: 0, y: 0 };

        function renderMaze() {
            maze.innerHTML = "";
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = document.createElement("div");
                    cell.classList.add("cell");
                    if (layout[y][x] === 1) cell.classList.add("wall");
                    if (layout[y][x] === 2) cell.classList.add("start");
                    if (layout[y][x] === 3) cell.classList.add("end");
                    if (particle.x === x && particle.y === y)
                        cell.classList.add("particle");
                    maze.appendChild(cell);
                }
            }
        }

        function findStart() {
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    if (layout[y][x] === 2) {
                        particle.x = x;
                        particle.y = y;
                        return;
                    }
                }
            }
        }

        // Función para mover la partícula (usada por voz y teclado)
        function moveParticle(dx, dy) {
            const nx = particle.x + dx;
            const ny = particle.y + dy;
            if (
                nx >= 0 &&
                nx < cols &&
                ny >= 0 &&
                ny < rows &&
                layout[ny][nx] !== 1
            ) {
                particle.x = nx;
                particle.y = ny;
                renderMaze();
                if (layout[ny][nx] === 3) {
                    document.getElementById("status").textContent =
                        "¡Llegaste al punto B!";
                } else {
                    document.getElementById("status").textContent = "";
                    // 10% de probabilidad de lanzar Monty Hall (y no en la meta ni en el inicio)
                    if (Math.random() < 0.1 && layout[ny][nx] === 0) {
                        showMontyHall(function (ganaste) {
                            if (!ganaste) {
                                findStart();
                                renderMaze();
                                document.getElementById("status").textContent =
                                    "¡Perdiste en Monty Hall! Vuelves al inicio.";
                            } else {
                                document.getElementById("status").textContent =
                                    "¡Ganaste en Monty Hall! Continúas tu camino.";
                            }
                        });
                    }
                }
            }
        }

        // Eventos de teclado
        document.addEventListener("keydown", (e) => {
            if (e.key === "ArrowUp") moveParticle(0, -1);
            if (e.key === "ArrowDown") moveParticle(0, 1);
            if (e.key === "ArrowLeft") moveParticle(-1, 0);
            if (e.key === "ArrowRight") moveParticle(1, 0);
        });

        // Botón nueva partida
        document.getElementById("new-game").addEventListener("click", () => {
            // Resetear historial de comandos GLC
            fetch('/glc/reset_nueva_partida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('🔄 Historial GLC reseteado por botón nueva partida');
                }
            })
            .catch(error => {
                console.error('Error al resetear historial GLC:', error);
            });

            // Resetear el juego del laberinto
            layout = generateMaze(10, 10);
            findStart();
            renderMaze();
            document.getElementById("status").textContent = "";
        });

        // Función para mostrar el modal de advertencia
        function showWarningModal() {
            document.getElementById("warning-modal").style.display = "flex";
        }

        // Función para ocultar el modal de advertencia
        function hideWarningModal() {
            document.getElementById("warning-modal").style.display = "none";
        }

        // Función para ir al autómata (después de confirmar)
        function goToAutomata() {
            // Resetear historial de comandos GLC antes de ir al autómata
            fetch('/glc/reset_nueva_partida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('🔄 Historial GLC reseteado antes de ir al autómata');
                }
                // Redirigir al autómata
                window.location.href = "{{ url_for('mostrar_arbol_voz_Automata') }}";
            })
            .catch(error => {
                console.error('Error al resetear historial GLC:', error);
                // Redirigir de todas formas
                window.location.href = "{{ url_for('mostrar_arbol_voz_Automata') }}";
            });
        }

        // Event listeners para el botón "Ir al Autómata" y el modal
        document.getElementById("go-to-automata").addEventListener("click", (e) => {
            e.preventDefault();
            showWarningModal();
        });

        document.getElementById("confirm-continue").addEventListener("click", () => {
            hideWarningModal();
            goToAutomata();
        });

        document.getElementById("cancel-action").addEventListener("click", () => {
            hideWarningModal();
        });

        // Cerrar modal si se hace clic fuera de él
        document.getElementById("warning-modal").addEventListener("click", (e) => {
            if (e.target === document.getElementById("warning-modal")) {
                hideWarningModal();
            }
        });

        // Cerrar modal con la tecla Escape
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && document.getElementById("warning-modal").style.display === "flex") {
                hideWarningModal();
            }
        });

        // Reconocimiento de voz
        window.SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            const recognition = new window.SpeechRecognition();
            recognition.lang = "es-ES";
            recognition.continuous = true;
            recognition.interimResults = false;

            // Variables para Monty Hall por voz
            window.montyVoice = window.montyVoice || {
                active: false,
                selectDoor: null,
                selectAction: null,
            };

            recognition.onresult = function (event) {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript
                            .trim()
                            .toLowerCase();

                        // Enviar comando al sistema GLC para análisis y registro
                        if (typeof enviarComandoGLC === 'function') {
                            enviarComandoGLC(transcript);
                        }

                        // Si el modal Monty Hall está activo
                        if (
                            document.getElementById("monty-modal").style.display === "flex"
                        ) {
                            if (transcript.includes("puerta a"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(0);
                            if (transcript.includes("puerta b"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(1);
                            if (transcript.includes("puerta c"))
                                window.montyVoice.selectDoor &&
                                    window.montyVoice.selectDoor(2);
                            if (transcript.includes("cambiar"))
                                window.montyVoice.selectAction &&
                                    window.montyVoice.selectAction(true);
                            if (transcript.includes("mantener"))
                                window.montyVoice.selectAction &&
                                    window.montyVoice.selectAction(false);
                            if (transcript.includes("cerrar"))
                                window.montyVoice.closeModal &&
                                    window.montyVoice.closeModal();
                            if (transcript.includes("reiniciar") || transcript.includes("otra vez"))
                                window.montyVoice.restartGame &&
                                    window.montyVoice.restartGame();
                        } else {
                            // Comandos de movimiento normales
                            if (transcript.includes("izquierda")) moveParticle(-1, 0);
                            if (transcript.includes("derecha")) moveParticle(1, 0);
                            if (transcript.includes("arriba")) moveParticle(0, -1);
                            if (transcript.includes("abajo")) moveParticle(0, 1);
                        }
                    }
                }
            };

            recognition.onerror = function (e) {
                document.getElementById("status").textContent =
                    "Error de reconocimiento de voz: " + e.error;
            };

            recognition.start();
            document.getElementById("status").textContent =
                ''
        } else {
            document.getElementById("status").textContent =
                "Reconocimiento de voz no soportado en este navegador.";
        }

        // Inicializar el juego
        findStart();
        renderMaze();
    </script>
    <!-- Integración con sistema GLC -->
    <script src="{{ url_for('static', filename='js/integracionGLCVoz.js') }}"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cambio: usar url_for para los CSS - SIN duplicar static/ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/montyhall.css') }}">
    
    <title>Juego Monty Hall</title>
    <style>
        .monty-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .doors {
            display: flex;
            gap: 40px;
            margin: 30px 0;
        }
        .door {
            cursor: pointer;
            transition: transform 0.2s;
            height: 266px;
            width: 133px;
            object-fit: contain;
        }
        /* Botones de cambio centrados y separados */
        .change-btns {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 18px;
        }
        .door.selected {
            transform: scale(1.1);
            border: 2px solid #007bff;
        }
        .door-label {
            text-align: center;
            font-weight: bold;
            margin-top: 8px;
        }
        .presenter-img {
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .stats {
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-monty {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1em;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Estilos del laberinto */
        #maze {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            grid-template-rows: repeat(10, 40px);
            gap: 2px;
            margin-top: 20px;
        }
        .cell {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .wall {
            background: #222;
        }
        .start {
            background: #4caf50;
        }
        .end {
            background: #2196f3;
        }
        .particle {
            background: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <header>
        <a href="#" class="logo">AUTOMATAS</a>
        
        <nav>
            <!-- Cambio: usar url_for para las rutas de navegaci√≥n -->
            <a href="{{ url_for('index') }}" class="active"> Inicio</a>
            <a href="{{ url_for('laberinto') }}" >Juego</a>
            <a href="#" >Documentaci√≥n</a>
            <a href="#" >Acerca De</a>
        </nav>
    </header>

    <!-- Contenedor del laberinto reemplazando el monty-container -->
    <div class="monty-container">
        <h2>Laberinto: Mueve la part√≠cula roja con las flechas</h2>
        <div id="maze"></div>
        <p id="status"></p>
        <button id="new-game" class="btn-monty">Nueva partida</button>
        <button 
            id="view-glc-tree" 
            class="btn-monty" 
            style="background: #667eea; margin-left: 10px;"
            onclick="window.open('/glc/arbol', '_blank')"
        >
            üå≥ Ver √Årbol GLC
        </button>
        <button 
            id="view-automata" 
            class="btn-monty" 
            style="background: #764ba2; margin-left: 10px;"
            onclick="abrirAutomata()"
        >
            ü§ñ Ver Aut√≥mata
        </button>
        
        <!-- Panel de estado del aut√≥mata -->
        <div id="automata-status-panel" style="
            background: rgba(255,255,255,0.9);
            border: 2px solid #764ba2;
            border-radius: 8px;
            padding: 15px;
            margin: 20px auto;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        ">
            <h4 style="margin: 0 0 10px 0; color: #764ba2; text-align: center;">ü§ñ Estado del Aut√≥mata</h4>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span><strong>Estados:</strong></span>
                <span id="automata-estados">1</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span><strong>Transiciones:</strong></span>
                <span id="automata-transiciones">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span><strong>Comandos v√°lidos:</strong></span>
                <span id="automata-comandos">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span><strong>Comandos rechazados:</strong></span>
                <span id="automata-rechazados" style="color: #dc3545;">0</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span><strong>Estado actual:</strong></span>
                <span id="automata-estado-actual">INICIO</span>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #28a745;">
                <small><strong>üéØ Filtro activo:</strong> Solo comandos de la gram√°tica</small>
            </div>
        </div>
    </div>

    <!-- Modal para Monty Hall -->
    <div id="monty-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    ">
        <div style="
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            min-width: 300px;
            text-align: center;
            position: relative;
        ">
            <h3>¬°Juego Monty Hall!</h3>
            <p>Elige una puerta:</p>
            <div id="monty-doors" style="
                display: flex;
                justify-content: center;
                gap: 30px;
                margin: 20px 0;
            "></div>
            <div id="monty-message"></div>
            <button id="monty-close" style="display: none; margin-top: 20px">Cerrar</button>
        </div>
    </div>

    <!-- L√≥gica del Monty Hall separada -->
    <script src="{{ url_for('static', filename='js/montyLaberinto.js') }}"></script>

    <script>
        // Generador simple de laberintos aleatorios con un camino garantizado
        function generateMaze(rows, cols) {
            // Inicializa todo como pared
            let maze = Array.from({ length: rows }, () => Array(cols).fill(1));
            // Crea un camino aleatorio desde (0,0) a (rows-1,cols-2)
            let x = 0, y = 0;
            maze[y][x] = 2; // inicio
            let path = [[x, y]];
            while (x < cols - 2 || y < rows - 1) {
                if (x === cols - 2) {
                    y++;
                } else if (y === rows - 1) {
                    x++;
                } else {
                    if (Math.random() < 0.5) x++;
                    else y++;
                }
                maze[y][x] = 0;
                path.push([x, y]);
            }
            maze[rows - 1][cols - 2] = 0;
            maze[rows - 1][cols - 1] = 3; // meta

            // A√±ade caminos secundarios aleatorios
            for (let i = 0; i < rows * cols * 0.25; i++) {
                let rx = Math.floor(Math.random() * cols);
                let ry = Math.floor(Math.random() * rows);
                if (maze[ry][rx] === 1) maze[ry][rx] = 0;
            }
            return maze;
        }

        let layout = generateMaze(10, 10);
        const maze = document.getElementById("maze");
        const rows = layout.length;
        const cols = layout[0].length;
        let particle = { x: 0, y: 0 };

        function renderMaze() {
            maze.innerHTML = "";
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = document.createElement("div");
                    cell.classList.add("cell");
                    if (layout[y][x] === 1) cell.classList.add("wall");
                    if (layout[y][x] === 2) cell.classList.add("start");
                    if (layout[y][x] === 3) cell.classList.add("end");
                    if (particle.x === x && particle.y === y)
                        cell.classList.add("particle");
                    maze.appendChild(cell);
                }
            }
        }

        function findStart() {
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    if (layout[y][x] === 2) {
                        particle.x = x;
                        particle.y = y;
                        return;
                    }
                }
            }
        }

        // Funci√≥n para mover la part√≠cula (usada por voz y teclado)
        function moveParticle(dx, dy) {
            const nx = particle.x + dx;
            const ny = particle.y + dy;
            if (
                nx >= 0 &&
                nx < cols &&
                ny >= 0 &&
                ny < rows &&
                layout[ny][nx] !== 1
            ) {
                particle.x = nx;
                particle.y = ny;
                renderMaze();
                if (layout[ny][nx] === 3) {
                    document.getElementById("status").textContent =
                        "¬°Llegaste al punto B!";
                } else {
                    document.getElementById("status").textContent = "";
                    // 10% de probabilidad de lanzar Monty Hall (y no en la meta ni en el inicio)
                    if (Math.random() < 0.1 && layout[ny][nx] === 0) {
                        showMontyHall(function (ganaste) {
                            if (!ganaste) {
                                findStart();
                                renderMaze();
                                document.getElementById("status").textContent =
                                    "¬°Perdiste en Monty Hall! Vuelves al inicio.";
                            } else {
                                document.getElementById("status").textContent =
                                    "¬°Ganaste en Monty Hall! Contin√∫as tu camino.";
                            }
                        });
                    }
                }
            }
        }

        // Eventos de teclado
        document.addEventListener("keydown", (e) => {
            if (e.key === "ArrowUp") moveParticle(0, -1);
            if (e.key === "ArrowDown") moveParticle(0, 1);
            if (e.key === "ArrowLeft") moveParticle(-1, 0);
            if (e.key === "ArrowRight") moveParticle(1, 0);
        });

        // Bot√≥n nueva partida
        document.getElementById("new-game").addEventListener("click", () => {
            layout = generateMaze(10, 10);
            findStart();
            renderMaze();
            document.getElementById("status").textContent = "";
        });

        // Reconocimiento de voz
        window.SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            const recognition = new window.SpeechRecognition();
            recognition.lang = "es-ES";
            recognition.continuous = true;
            recognition.interimResults = false;

            // Contadores para estad√≠sticas
            let comandosRechazados = 0;
            let comandosValidos = 0;

            // Diccionario de palabras v√°lidas seg√∫n la gram√°tica
            const PALABRAS_VALIDAS = {
                // Comandos de movimiento
                'izquierda': true,
                'derecha': true,
                'arriba': true,
                'abajo': true,
                
                // Comandos Monty Hall - Puertas
                'puerta': true,
                'a': true,
                'b': true,
                'c': true,
                
                // Comandos Monty Hall - Acciones
                'cambiar': true,
                'mantener': true,
                
                // Comandos Monty Hall - Control
                'cerrar': true,
                'reiniciar': true,
                'otra': true,
                'vez': true,
                
                // Comandos del juego
                'nueva': true,
                'partida': true
            };

            // Funci√≥n para validar si un comando es v√°lido seg√∫n la gram√°tica
            function esComandoValido(transcript) {
                const palabras = transcript.toLowerCase().trim().split(/\s+/);
                
                // Verificar que todas las palabras est√©n en el diccionario
                for (const palabra of palabras) {
                    if (!PALABRAS_VALIDAS[palabra]) {
                        return false;
                    }
                }

                // Verificar patrones espec√≠ficos de la gram√°tica
                const texto = palabras.join(' ');
                
                // Comandos de movimiento (palabras individuales)
                if (palabras.length === 1) {
                    return ['izquierda', 'derecha', 'arriba', 'abajo', 'cambiar', 'mantener', 'cerrar', 'reiniciar'].includes(palabras[0]);
                }
                
                // Comandos de dos palabras
                if (palabras.length === 2) {
                    // Patr√≥n "puerta X"
                    if (palabras[0] === 'puerta' && ['a', 'b', 'c'].includes(palabras[1])) {
                        return true;
                    }
                    // Patr√≥n "otra vez"
                    if (palabras[0] === 'otra' && palabras[1] === 'vez') {
                        return true;
                    }
                    // Patr√≥n "nueva partida"
                    if (palabras[0] === 'nueva' && palabras[1] === 'partida') {
                        return true;
                    }
                }
                
                return false;
            }

            // Funci√≥n para normalizar comandos (corregir variaciones comunes)
            function normalizarComando(transcript) {
                let comando = transcript.toLowerCase().trim();
                
                // Correcciones comunes de reconocimiento de voz
                const correcciones = {
                    'ezquierda': 'izquierda',
                    'isquierda': 'izquierda',
                    'derecha.': 'derecha',
                    'arriba.': 'arriba',
                    'abajo.': 'abajo',
                    'puerto a': 'puerta a',
                    'puerto b': 'puerta b',
                    'puerto c': 'puerta c',
                    'puerta.': 'puerta',
                    'cambiar.': 'cambiar',
                    'mantener.': 'mantener',
                    'reiniciar.': 'reiniciar',
                    'cerrar.': 'cerrar',
                    'partida.': 'partida',
                    'nueva.': 'nueva'
                };
                
                // Aplicar correcciones
                for (const [incorrecto, correcto] of Object.entries(correcciones)) {
                    comando = comando.replace(incorrecto, correcto);
                }
                
                // Limpiar espacios extra
                comando = comando.replace(/\s+/g, ' ').trim();
                
                return comando;
            }

            // Funci√≥n para dar retroalimentaci√≥n sobre comandos no reconocidos
            function mostrarComandosValidos() {
                const comandosValidos = [
                    'üì± Comandos de Movimiento: "izquierda", "derecha", "arriba", "abajo"',
                    'üö™ Comandos de Puertas: "puerta a", "puerta b", "puerta c"',
                    'üéØ Comandos de Acci√≥n: "cambiar", "mantener"',
                    'üéÆ Comandos de Control: "cerrar", "reiniciar", "otra vez"',
                    'üÜï Comando de Juego: "nueva partida"'
                ];
                
                return comandosValidos.join('\n');
            }

            // Variables para Monty Hall por voz
            window.montyVoice = window.montyVoice || {
                active: false,
                selectDoor: null,
                selectAction: null,
            };

            recognition.onresult = function (event) {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const transcriptOriginal = event.results[i][0].transcript.trim();
                        const transcript = normalizarComando(transcriptOriginal);

                        console.log(`üé§ Comando original: "${transcriptOriginal}"`);
                        console.log(`üîß Comando normalizado: "${transcript}"`);

                        // ‚úÖ FILTRO: Validar si el comando es v√°lido seg√∫n la gram√°tica
                        if (!esComandoValido(transcript)) {
                            comandosRechazados++;
                            document.getElementById("automata-rechazados").textContent = comandosRechazados;
                            
                            console.warn(`‚ùå Comando no v√°lido: "${transcript}"`);
                            document.getElementById("status").textContent = 
                                `‚ùå "${transcriptOriginal}" no es un comando v√°lido`;
                            
                            // Mostrar comandos v√°lidos por 4 segundos
                            setTimeout(() => {
                                document.getElementById("status").textContent = 
                                    'üé§ Solo comandos v√°lidos: izquierda, derecha, arriba, abajo, puerta a/b/c, cambiar, mantener, cerrar, reiniciar, nueva partida';
                            }, 4000);
                            
                            return; // ‚õî DETENER procesamiento si no es v√°lido
                        }

                        // ‚úÖ El comando es v√°lido, proceder con el procesamiento
                        comandosValidos++;
                        console.log(`‚úÖ Comando v√°lido procesando: "${transcript}"`);
                        
                        // Actualizar status con comando reconocido
                        document.getElementById("status").textContent = `‚úÖ "${transcript}" - Ejecutando...`;

                        // Enviar comando normalizado al sistema GLC para an√°lisis y registro
                        if (typeof enviarComandoGLC === 'function') {
                            enviarComandoGLC(transcript);
                        }

                        // Enviar comando normalizado al sistema AFND para construcci√≥n del aut√≥mata
                        if (typeof procesarComandoAutomata === 'function') {
                            procesarComandoAutomata(transcript).catch(error => {
                                console.warn('Error en aut√≥mata:', error);
                            });
                        }

                        // Si el modal Monty Hall est√° activo
                        if (
                            document.getElementById("monty-modal").style.display === "flex"
                        ) {
                            // Comandos espec√≠ficos de Monty Hall
                            if (transcript === "puerta a")
                                window.montyVoice.selectDoor && window.montyVoice.selectDoor(0);
                            else if (transcript === "puerta b")
                                window.montyVoice.selectDoor && window.montyVoice.selectDoor(1);
                            else if (transcript === "puerta c")
                                window.montyVoice.selectDoor && window.montyVoice.selectDoor(2);
                            else if (transcript === "cambiar")
                                window.montyVoice.selectAction && window.montyVoice.selectAction(true);
                            else if (transcript === "mantener")
                                window.montyVoice.selectAction && window.montyVoice.selectAction(false);
                            else if (transcript === "cerrar")
                                window.montyVoice.closeModal && window.montyVoice.closeModal();
                            else if (transcript === "reiniciar" || transcript === "otra vez")
                                window.montyVoice.restartGame && window.montyVoice.restartGame();
                        } else {
                            // Comandos de movimiento normales (solo en modo laberinto)
                            if (transcript === "izquierda") moveParticle(-1, 0);
                            else if (transcript === "derecha") moveParticle(1, 0);
                            else if (transcript === "arriba") moveParticle(0, -1);
                            else if (transcript === "abajo") moveParticle(0, 1);
                            else if (transcript === "nueva partida") {
                                // Reiniciar el juego completo
                                layout = generateMaze(10, 10);
                                findStart();
                                renderMaze();
                                document.getElementById("status").textContent = "üÜï Nueva partida iniciada";
                            }
                        }

                        // Limpiar mensaje despu√©s de 2 segundos
                        setTimeout(() => {
                            if (document.getElementById("status").textContent.includes("‚úÖ Comando:")) {
                                document.getElementById("status").textContent = 'üé§ Reconocimiento activo - Solo comandos v√°lidos';
                            }
                        }, 2000);
                    }
                }
            };

            recognition.onerror = function (e) {
                document.getElementById("status").textContent =
                    "Error de reconocimiento de voz: " + e.error;
            };

            recognition.start();
            document.getElementById("status").textContent =
                'üé§ Reconocimiento de voz activo - Solo comandos v√°lidos:\n' + mostrarComandosValidos();
        } else {
            document.getElementById("status").textContent =
                "‚ùå Reconocimiento de voz no soportado en este navegador.";
        }

        // Inicializar el juego
        findStart();
        renderMaze();
    </script>
    <!-- Integraci√≥n con sistema GLC -->
    <script src="{{ url_for('static', filename='js/integracionGLCVoz.js') }}"></script>
    <!-- Integraci√≥n con sistema AFND -->
    <script src="{{ url_for('static', filename='js/automataIntegracion.js') }}"></script>
</body>
</html>